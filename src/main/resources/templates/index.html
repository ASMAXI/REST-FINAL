<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .centered-content {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .table-container {
            width: 100%;
            max-width: 800px;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .user-info-block {
            background-color: #343a40;
            color: #fff;
            padding: 10px;
            text-align: center;
            margin-bottom: 20px;
        }
        .sidebar {
            background-color: #e9ecef;
            padding: 20px;
            width: 200px;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
        }
        .content {
            margin-left: 220px;
            padding: 20px;
        }
    </style>
</head>
<body>
<div class="sidebar">
    <button class="btn btn-block btn-primary" id="adminButton">ADMIN</button>
    <button class="btn btn-block btn-secondary" id="userButton">USER</button>
</div>
<div class="content">
    <div class="user-info-block">
        <p id="currentUserEmail"></p>
        <p id="currentUserRole"></p>
    </div>
    <div id="adminPanel" style="display: none;">
        <h1 class="text-center mb-4">Admin Panel</h1>
        <ul class="nav nav-tabs" id="adminTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="usersTab" data-toggle="tab" href="#users" role="tab" aria-controls="users" aria-selected="true">Users</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="addUserTab" data-toggle="tab" href="#addUser" role="tab" aria-controls="addUser" aria-selected="false">Add new User</a>
            </li>
        </ul>
        <div class="tab-content" id="adminTabsContent">
            <div class="tab-pane fade show active" id="users" role="tabpanel" aria-labelledby="usersTab">
                <div class="row">
                    <div class="col-md-12">
                        <h2 class="text-center">Users</h2>
                        <table class="table table-striped">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Last name</th>
                                <th>Age</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody id="usersTable">
                            <!-- Users will be loaded here via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="addUser" role="tabpanel" aria-labelledby="addUserTab">
                <div class="row">
                    <div class="col-md-12">
                        <h2 class="text-center">Add new User</h2>
                        <form id="addUserForm">
                            <div class="form-group">
                                <label for="addUserName">Name</label>
                                <input type="text" class="form-control" id="addUserName" required>
                            </div>
                            <div class="form-group">
                                <label for="addUserLastName">Last Name</label>
                                <input type="text" class="form-control" id="addUserLastName" required>
                            </div>
                            <div class="form-group">
                                <label for="addUserAge">Age</label>
                                <input type="number" class="form-control" id="addUserAge" required>
                            </div>
                            <div class="form-group">
                                <label for="addUserEmail">Email</label>
                                <input type="email" class="form-control" id="addUserEmail" required>
                            </div>
                            <div class="form-group">
                                <label for="addUserPassword">Password</label>
                                <input type="password" class="form-control" id="addUserPassword" required>
                            </div>
                            <div class="form-group">
                                <label for="addUserRoles">Roles</label>
                                <select class="form-control" id="addUserRoles" name="roles" multiple required>
                                    <!-- Options will be populated via JavaScript -->
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Add User</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="userPanel" style="display: none;">
        <h1 class="text-center mb-4">User Info</h1>
        <div class="row">
            <div class="col-md-12">
                <h2 class="text-center">Your Information</h2>
                <p><strong>ID:</strong> <span id="userInfoId"></span></p>
                <p><strong>Name:</strong> <span id="userInfoName"></span></p>
                <p><strong>Last Name:</strong> <span id="userInfoLastName"></span></p>
                <p><strong>Age:</strong> <span id="userInfoAge"></span></p>
                <p><strong>Email:</strong> <span id="userInfoEmail"></span></p>
                <p><strong>Roles:</strong> <span id="userInfoRoles"></span></p>
            </div>
        </div>
    </div>
</div>

<!-- Modal for editing user -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId">
                    <div class="form-group">
                        <label for="editUserName">Name</label>
                        <input type="text" class="form-control" id="editUserName">
                    </div>
                    <div class="form-group">
                        <label for="editUserLastName">Last Name</label>
                        <input type="text" class="form-control" id="editUserLastName">
                    </div>
                    <div class="form-group">
                        <label for="editUserAge">Age</label>
                        <input type="number" class="form-control" id="editUserAge">
                    </div>
                    <div class="form-group">
                        <label for="editUserEmail">Email</label>
                        <input type="email" class="form-control" id="editUserEmail">
                    </div>
                    <div class="form-group">
                        <label for="editUserRoles">Roles</label>
                        <select class="form-control" id="editUserRoles" multiple>
                            <option value="ROLE_USER">ROLE_USER</option>
                            <option value="ROLE_ADMIN">ROLE_ADMIN</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveUserChanges">Save changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for deleting user -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteUserModalLabel">Confirm Delete</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the following user?</p>
                <p><strong>ID:</strong> <span id="deleteUserId"></span></p>
                <p><strong>Name:</strong> <span id="deleteUserName"></span></p>
                <p><strong>Last Name:</strong> <span id="deleteUserLastName"></span></p>
                <p><strong>Age:</strong> <span id="deleteUserAge"></span></p>
                <p><strong>Email:</strong> <span id="deleteUserEmail"></span></p>
                <p><strong>Roles:</strong> <span id="deleteUserRoles"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteUser">Delete</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Load current user info
        fetch('/api/admin/current-user')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(user => {
                document.getElementById('currentUserEmail').textContent = `Email: ${user.email}`;
                document.getElementById('currentUserRole').textContent = `Role: ${user.roles.map(role => role.name).join(', ')}`;

                // Check if the user has admin role
                const isAdmin = user.roles.some(role => role.name === 'ROLE_ADMIN');
                if (isAdmin) {
                    document.getElementById('adminPanel').style.display = 'block';
                    document.getElementById('userPanel').style.display = 'none';
                    loadUsers();
                } else {
                    document.getElementById('adminPanel').style.display = 'none';
                    document.getElementById('userPanel').style.display = 'block';
                    loadUserInfo();
                }
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
            });

        // Load users
        function loadUsers() {
            fetch('/api/admin/users')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(users => {
                    const usersTable = document.getElementById('usersTable');
                    usersTable.innerHTML = '';
                    users.forEach(user => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${user.id}</td>
                            <td>${user.name}</td>
                            <td>${user.last_name}</td>
                            <td>${user.age}</td>
                            <td>${user.email}</td>
                            <td>${user.roles.map(role => role.name).join(', ')}</td>
                            <td>
                                <button class="btn btn-sm btn-primary edit-user" data-id="${user.id}">Edit</button>
                                <button class="btn btn-sm btn-danger delete-user" data-id="${user.id}">Delete</button>
                            </td>
                        `;
                        usersTable.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                });
        }

        // Load user info
        function loadUserInfo() {
            fetch('/api/admin/current-user')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(user => {
                    document.getElementById('userInfoId').textContent = user.id;
                    document.getElementById('userInfoName').textContent = user.name;
                    document.getElementById('userInfoLastName').textContent = user.last_name;
                    document.getElementById('userInfoAge').textContent = user.age;
                    document.getElementById('userInfoEmail').textContent = user.email;
                    document.getElementById('userInfoRoles').textContent = user.roles.map(role => role.name).join(', ');
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                });
        }

        // Handle sidebar buttons
        document.getElementById('adminButton').addEventListener('click', function () {
            document.getElementById('adminPanel').style.display = 'block';
            document.getElementById('userPanel').style.display = 'none';
            loadUsers();
        });

        document.getElementById('userButton').addEventListener('click', function () {
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('userPanel').style.display = 'block';
            loadUserInfo();
        });

        // Handle user actions
        document.addEventListener('click', function (event) {
            if (event.target.classList.contains('edit-user')) {
                const userId = event.target.getAttribute('data-id');
                fetch(`/api/admin/users/${userId}`)
                    .then(response => response.json())
                    .then(user => {
                        $('#editUserId').val(user.id);
                        $('#editUserName').val(user.name);
                        $('#editUserLastName').val(user.last_name);
                        $('#editUserAge').val(user.age);
                        $('#editUserEmail').val(user.email);
                        $('#editUserRoles').val(user.roles.map(role => role.name));
                        $('#editUserModal').modal('show');
                    })
                    .catch(error => {
                        console.error('There was a problem with the fetch operation:', error);
                    });
            } else if (event.target.classList.contains('delete-user')) {
                const userId = event.target.getAttribute('data-id');
                fetch(`/api/admin/users/${userId}`)
                    .then(response => response.json())
                    .then(user => {
                        $('#deleteUserId').text(user.id);
                        $('#deleteUserName').text(user.name);
                        $('#deleteUserLastName').text(user.last_name);
                        $('#deleteUserAge').text(user.age);
                        $('#deleteUserEmail').text(user.email);
                        $('#deleteUserRoles').text(user.roles.map(role => role.name).join(', '));
                        $('#deleteUserModal').modal('show');
                    })
                    .catch(error => {
                        console.error('There was a problem with the fetch operation:', error);
                    });
            }
        });

        // Save user changes
        document.getElementById('saveUserChanges').addEventListener('click', function () {
            const userId = $('#editUserId').val();
            const userDetails = {
                name: $('#editUserName').val(),
                last_name: $('#editUserLastName').val(),
                age: $('#editUserAge').val(),
                email: $('#editUserEmail').val(),
                roles: $('#editUserRoles').val()
            };

            fetch(`/api/admin/users/${userId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userDetails)
            })
                .then(response => response.json())
                .then(() => {
                    $('#editUserModal').modal('hide');
                    loadUsers(); // Reload users after update
                })
                .catch(error => {
                    console.error('There was a problem with the update operation:', error);
                });
        });

        // Add new user
        document.getElementById('addUserForm').addEventListener('submit', function (event) {
            event.preventDefault();
            const newUser = {
                name: $('#addUserName').val(),
                last_name: $('#addUserLastName').val(),
                age: $('#addUserAge').val(),
                email: $('#addUserEmail').val(),
                password: $('#addUserPassword').val(),
                roles: $('#addUserRoles').val()
            };

            fetch('/api/admin/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(newUser)
            })
                .then(response => response.json())
                .then(addedUser => {
                    // Clear the form
                    $('#addUserForm')[0].reset();

                    // Switch to the Admin Panel tab
                    $('#addUserTab').removeClass('active');
                    $('#usersTab').addClass('active');
                    $('#addUser').removeClass('show active');
                    $('#users').addClass('show active');

                    loadUsers(); // Reload users after add
                })
                .catch(error => {
                    console.error('There was a problem with the add user operation:', error);
                });
        });

        // Confirm delete user
        document.getElementById('confirmDeleteUser').addEventListener('click', function () {
            const userId = $('#deleteUserId').text();
            fetch(`/api/admin/users/${userId}`, {
                method: 'DELETE'
            })
                .then(() => {
                    $('#deleteUserModal').modal('hide');
                    loadUsers(); // Reload users after delete
                })
                .catch(error => {
                    console.error('There was a problem with the delete operation:', error);
                });
        });

        // Load roles for the add user form
        function loadRoles() {
            fetch('/api/admin/roles')
                .then(response => response.json())
                .then(roles => {
                    const rolesSelect = document.getElementById('addUserRoles');
                    roles.forEach(role => {
                        const option = document.createElement('option');
                        option.value = role.id;
                        option.textContent = role.name;
                        rolesSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                });
        }

        // Load roles when the page loads
        loadRoles();
    });
</script>
</body>
</html>